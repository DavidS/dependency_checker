#!/usr/bin/env ruby

require 'json'
require 'sinatra'

begin
  require 'puppet_metadata_checker'
rescue LoadError
  $LOAD_PATH.unshift(*Dir[File.expand_path("../../lib", __FILE__)])
  require 'puppet_metadata_checker'
end

cache = PuppetMetadataChecker::ForgeMemcache.new
forge = PuppetMetadataChecker::ForgeVersions.new(cache)

post '/metadata' do
  request.body.rewind  # in case someone already read it
  metadata = JSON.parse(request.body.read)
  checker = PuppetMetadataChecker::MetadataChecker.new(metadata, forge)

  result = {
    :name => metadata['name'],
    :dependencies => checker.dependencies.map do |dependency, constraint, current, satisfied|
      {
        :dependency => dependency,
        :constraint => constraint,
        :current => current,
        :satisfied => satisfied,
      }
    end,
  }

  result.to_json
end
